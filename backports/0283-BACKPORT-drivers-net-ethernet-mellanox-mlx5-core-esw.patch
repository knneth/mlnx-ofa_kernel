From: Valentine Fatiev <valentinef@nvidia.com>
Subject: [PATCH] BACKPORT: drivers/net/ethernet/mellanox/mlx5/core/esw/qos.c

Change-Id: I179007dde9b18210e0adca79fded7dbd76d579eb
---
 .../net/ethernet/mellanox/mlx5/core/esw/qos.c | 95 ++++++++++---------
 1 file changed, 52 insertions(+), 43 deletions(-)

--- a/drivers/net/ethernet/mellanox/mlx5/core/esw/qos.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/esw/qos.c
@@ -8,6 +8,9 @@
 #include "mlx5_devm.h"
 #define CREATE_TRACE_POINTS
 #include "diag/qos_tracepoint.h"
+#ifdef HAVE_BASECODE_EXTRAS
+#include <linux/dcbnl.h>
+#endif
 
 /* Minimum supported BW share value by the HW is 1 Mbit/sec */
 #define MLX5_MIN_BW_SHARE 1
@@ -93,7 +96,6 @@ esw_qos_node_set_parent(struct mlx5_esw_
 	esw_qos_node_attach_to_parent(node);
 }
 
-#ifdef HAVE_DEVLINK_HAS_RATE_TC_BW_SET
 static void esw_qos_nodes_set_parent(struct list_head *nodes,
 				     struct mlx5_esw_sched_node *parent)
 {
@@ -114,7 +116,6 @@ static void esw_qos_nodes_set_parent(str
 		}
 	}
 }
-#endif
 
 void mlx5_esw_qos_vport_qos_free(struct mlx5_vport *vport)
 {
@@ -512,7 +513,10 @@ static void __esw_qos_free_node(struct m
 	kfree(node);
 }
 
-static void esw_qos_destroy_node(struct mlx5_esw_sched_node *node, struct netlink_ext_ack *extack)
+#ifdef HAVE_DEVLINK_HAS_RATE_FUNCTIONS
+static
+#endif
+void esw_qos_destroy_node(struct mlx5_esw_sched_node *node, struct netlink_ext_ack *extack)
 {
 	esw_qos_node_destroy_sched_element(node, extack);
 	__esw_qos_free_node(node);
@@ -1294,7 +1298,6 @@ static int esw_qos_vport_update_parent(s
 	return esw_qos_vport_update(vport, type, parent, true, extack);
 }
 
-#ifdef HAVE_DEVLINK_HAS_RATE_TC_BW_SET
 static void
 esw_qos_switch_vport_tcs_to_vport(struct mlx5_esw_sched_node *tc_arbiter_node,
 				  struct mlx5_esw_sched_node *node,
@@ -1484,7 +1487,6 @@ out:
 	__esw_qos_free_node(curr_node);
 	return err;
 }
-#endif
 
 static u32 mlx5_esw_qos_lag_link_speed_get_locked(struct mlx5_core_dev *mdev)
 {
@@ -1509,8 +1511,8 @@ out:
 	return speed;
 }
 
-static int mlx5_esw_qos_max_link_speed_get(struct mlx5_core_dev *mdev, u32 *link_speed_max,
-					   bool hold_rtnl_lock, struct netlink_ext_ack *extack)
+int mlx5_esw_qos_max_link_speed_get(struct mlx5_core_dev *mdev, u32 *link_speed_max,
+				    bool hold_rtnl_lock, struct netlink_ext_ack *extack)
 {
 	int err;
 
@@ -1536,9 +1538,9 @@ skip_lag:
 	return err;
 }
 
-static int mlx5_esw_qos_link_speed_verify(struct mlx5_core_dev *mdev,
-					  const char *name, u32 link_speed_max,
-					  u64 value, struct netlink_ext_ack *extack)
+int mlx5_esw_qos_link_speed_verify(struct mlx5_core_dev *mdev,
+				  const char *name, u32 link_speed_max,
+				  u64 value, struct netlink_ext_ack *extack)
 {
 	if (value > link_speed_max) {
 		pr_err("%s rate value %lluMbps exceed link maximum speed %u.\n",
@@ -1584,8 +1586,8 @@ int mlx5_esw_qos_modify_vport_rate(struc
  * second, rewriting last. If converted rate exceed link speed or is not a
  * fraction of Mbps - returns error.
  */
-static int esw_qos_devlink_rate_to_mbps(struct mlx5_core_dev *mdev, const char *name,
-					u64 *rate, struct netlink_ext_ack *extack)
+int esw_qos_devlink_rate_to_mbps(struct mlx5_core_dev *mdev, const char *name,
+				 u64 *rate, struct netlink_ext_ack *extack)
 {
 	u32 link_speed_max, remainder;
 	u64 value;
@@ -1745,29 +1747,6 @@ unlock:
 	return err;
 }
 
-int
-mlx5_esw_get_esw_and_vport(struct devlink *devlink, struct devlink_port *port,
-			   struct mlx5_eswitch **esw, struct mlx5_vport **vport,
-			   struct netlink_ext_ack *extack)
-{
-	u16 vport_num;
-
-	*esw = mlx5_devlink_eswitch_get(devlink);
-	if (IS_ERR(*esw)) {
-		NL_SET_ERR_MSG_MOD(extack, "Esw not found");
-		return PTR_ERR(*esw);
-	}
-
-	vport_num = mlx5_esw_devlink_port_index_to_vport_num(port->index);
-	*vport = mlx5_eswitch_get_vport(*esw, vport_num);
-	if (IS_ERR(*vport)) {
-		NL_SET_ERR_MSG_MOD(extack, "Failed to get vport");
-		return PTR_ERR(*vport);
-	}
-
-	return 0;
-}
-
 void esw_qos_destroy_sched_node(struct mlx5_esw_sched_node *node,
 			       struct netlink_ext_ack *extack)
 {
@@ -1891,7 +1870,11 @@ void mlx5_esw_qos_cleanup(struct mlx5_es
 
 /* Eswitch devlink rate API */
 
-int mlx5_esw_devlink_rate_leaf_tx_share_set(struct devlink_rate *rate_leaf, void *priv,
+int mlx5_esw_devlink_rate_leaf_tx_share_set(
+#ifdef HAVE_DEVLINK_HAS_RATE_FUNCTIONS
+					    struct devlink_rate *rate_leaf,
+#endif
+					    void *priv,
 					    u64 tx_share, struct netlink_ext_ack *extack)
 {
 	struct mlx5_vport *vport = priv;
@@ -1916,7 +1899,11 @@ out:
 	return err;
 }
 
-int mlx5_esw_devlink_rate_leaf_tx_max_set(struct devlink_rate *rate_leaf, void *priv,
+int mlx5_esw_devlink_rate_leaf_tx_max_set(
+#ifdef HAVE_DEVLINK_HAS_RATE_FUNCTIONS
+					  struct devlink_rate *rate_leaf,
+#endif
+					  void *priv,
 					  u64 tx_max, struct netlink_ext_ack *extack)
 {
 	struct mlx5_vport *vport = priv;
@@ -1941,8 +1928,10 @@ out:
 	return err;
 }
 
+int mlx5_esw_devlink_rate_leaf_tc_bw_set(
 #ifdef HAVE_DEVLINK_HAS_RATE_TC_BW_SET
-int mlx5_esw_devlink_rate_leaf_tc_bw_set(struct devlink_rate *rate_leaf,
+					 struct devlink_rate *rate_leaf,
+#endif
 					 void *priv,
 					 u32 *tc_bw,
 					 struct netlink_ext_ack *extack)
@@ -1996,7 +1985,10 @@ unlock:
 	return err;
 }
 
-int mlx5_esw_devlink_rate_node_tc_bw_set(struct devlink_rate *rate_node,
+int mlx5_esw_devlink_rate_node_tc_bw_set(
+#ifdef HAVE_DEVLINK_HAS_RATE_TC_BW_SET
+					 struct devlink_rate *rate_node,
+#endif
 					 void *priv,
 					 u32 *tc_bw,
 					 struct netlink_ext_ack *extack)
@@ -2026,9 +2018,12 @@ unlock:
 	esw_qos_unlock(esw);
 	return err;
 }
-#endif
 
-int mlx5_esw_devlink_rate_node_tx_share_set(struct devlink_rate *rate_node, void *priv,
+int mlx5_esw_devlink_rate_node_tx_share_set(
+#ifdef HAVE_DEVLINK_HAS_RATE_FUNCTIONS
+					    struct devlink_rate *rate_node,
+#endif
+					    void *priv,
 					    u64 tx_share, struct netlink_ext_ack *extack)
 {
 	struct mlx5_esw_sched_node *node = priv;
@@ -2045,7 +2040,11 @@ int mlx5_esw_devlink_rate_node_tx_share_
 	return err;
 }
 
-int mlx5_esw_devlink_rate_node_tx_max_set(struct devlink_rate *rate_node, void *priv,
+int mlx5_esw_devlink_rate_node_tx_max_set(
+#ifdef HAVE_DEVLINK_HAS_RATE_FUNCTIONS
+					  struct devlink_rate *rate_node,
+#endif
+					  void *priv,
 					  u64 tx_max, struct netlink_ext_ack *extack)
 {
 	struct mlx5_esw_sched_node *node = priv;
@@ -2062,6 +2061,7 @@ int mlx5_esw_devlink_rate_node_tx_max_se
 	return err;
 }
 
+#ifdef HAVE_DEVLINK_HAS_RATE_FUNCTIONS
 int mlx5_esw_devlink_rate_node_new(struct devlink_rate *rate_node, void **priv,
 				   struct netlink_ext_ack *extack)
 {
@@ -2073,8 +2073,13 @@ int mlx5_esw_devlink_rate_node_new(struc
 	
 	return mlx5_esw_common_rate_node_new(esw, priv, extack);
 }
+#endif /* HAVE_DEVLINK_HAS_RATE_FUNCTIONS */
 
-int mlx5_esw_devlink_rate_node_del(struct devlink_rate *rate_node, void *priv,
+int mlx5_esw_devlink_rate_node_del(
+#ifdef HAVE_DEVLINK_HAS_RATE_FUNCTIONS
+				   struct devlink_rate *rate_node,
+#endif
+				   void *priv,
 				   struct netlink_ext_ack *extack)
 {
 	struct mlx5_esw_sched_node *node = priv;
@@ -2087,6 +2092,7 @@ int mlx5_esw_devlink_rate_node_del(struc
 	return 0;
 }
 
+#ifdef HAVE_DEVLINK_HAS_RATE_FUNCTIONS
 int mlx5_esw_devlink_rate_leaf_parent_set(struct devlink_rate *devlink_rate,
 					  struct devlink_rate *parent,
 					  void *priv, void *parent_priv,
@@ -2097,6 +2103,7 @@ int mlx5_esw_devlink_rate_leaf_parent_se
 
 	return mlx5_esw_common_rate_leaf_parent_set(node, vport, extack);
 }
+#endif /* HAVE_DEVLINK_HAS_RATE_FUNCTIONS */
 
 static bool esw_qos_is_node_empty(struct mlx5_esw_sched_node *node)
 {
@@ -2245,6 +2252,7 @@ out:
 
 	return err;
 }
+#ifdef HAVE_DEVLINK_HAS_RATE_FUNCTIONS
 
 int mlx5_esw_devlink_rate_node_parent_set(struct devlink_rate *devlink_rate,
 					  struct devlink_rate *parent,
@@ -2259,6 +2267,7 @@ int mlx5_esw_devlink_rate_node_parent_se
 	parent_node = parent_priv;
 	return mlx5_esw_qos_node_update_parent(node, parent_node, extack);
 }
+#endif
 
 int mlx5_esw_qos_vport_update_parent(struct mlx5_vport *vport, struct mlx5_esw_sched_node *parent,
 				     struct netlink_ext_ack *extack)
