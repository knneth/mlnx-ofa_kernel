From: Valentine Fatiev <valentinef@nvidia.com>
Subject: [PATCH] BACKPORT: drivers/nvme/host/sysfs.c

---
 drivers/nvme/host/sysfs.c | 24 ++++++++++++++++++++++++
 1 file changed, 24 insertions(+)

--- a/drivers/nvme/host/sysfs.c
+++ b/drivers/nvme/host/sysfs.c
@@ -5,7 +5,9 @@
  * Copyright (c) 2011-2014, Intel Corporation.
  */
 
+#ifdef HAVE_NVME_AUTH_TRANSFORM_KEY_DHCHAP
 #include <linux/nvme-auth.h>
+#endif
 
 #include "nvme.h"
 #include "fabrics.h"
@@ -300,11 +302,16 @@ static umode_t nvme_ns_attrs_are_visible
 	return a->mode;
 }
 
+#ifdef HAVE_DEVICE_ADD_DISK_3_ARGS
 static const struct attribute_group nvme_ns_attr_group = {
+#else
+const struct attribute_group nvme_ns_attr_group = {
+#endif
 	.attrs		= nvme_ns_attrs,
 	.is_visible	= nvme_ns_attrs_are_visible,
 };
 
+#ifdef HAVE_GD_ADDED
 #ifdef CONFIG_NVME_MULTIPATH
 /*
  * NOTE: The dummy attribute does not appear in sysfs. It exists solely to allow
@@ -322,6 +329,7 @@ static struct attribute *nvme_ns_mpath_a
 	NULL,
 };
 
+#ifdef HAVE_SYSFS_GROUP_INVISIBLE
 static bool multipath_sysfs_group_visible(struct kobject *kobj)
 {
 	struct device *dev = container_of(kobj, struct device, kobj);
@@ -336,19 +344,34 @@ static bool multipath_sysfs_attr_visible
 }
 
 DEFINE_SYSFS_GROUP_VISIBLE(multipath_sysfs)
+#else
+static umode_t nvme_ns_mpath_attr_is_visible(struct kobject *kobj,
+		struct attribute *attr, int n)
+{
+	return 0;
+}
+#endif
 
 const struct attribute_group nvme_ns_mpath_attr_group = {
 	.name           = "multipath",
 	.attrs		= nvme_ns_mpath_attrs,
+
+#ifdef HAVE_SYSFS_GROUP_INVISIBLE
 	.is_visible     = SYSFS_GROUP_VISIBLE(multipath_sysfs),
+#else
+	.is_visible     = nvme_ns_mpath_attr_is_visible,
+#endif
 };
 #endif
+#endif
 
 const struct attribute_group *nvme_ns_attr_groups[] = {
 	&nvme_ns_attr_group,
+#ifdef HAVE_GD_ADDED
 #ifdef CONFIG_NVME_MULTIPATH
 	&nvme_ns_mpath_attr_group,
 #endif
+#endif
 	NULL,
 };
 
@@ -394,6 +417,7 @@ static ssize_t nvme_sysfs_delete(struct
 		nvme_delete_ctrl_sync(ctrl);
 	return count;
 }
+
 static DEVICE_ATTR(delete_controller, S_IWUSR, NULL, nvme_sysfs_delete);
 
 static ssize_t nvme_sysfs_show_transport(struct device *dev,
