From: Valentine Fatiev <valentinef@nvidia.com>
Subject: [PATCH] BACKPORT:
 drivers/net/ethernet/mellanox/mlx5/core/steering/hws/bwc_complex.c

Change-Id: I33a81f1fdb2eaf552d3c4e804b8720005f8c7e62
---
 .../mlx5/core/steering/hws/bwc_complex.c         | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

--- a/drivers/net/ethernet/mellanox/mlx5/core/steering/hws/bwc_complex.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/steering/hws/bwc_complex.c
@@ -1078,7 +1078,11 @@ hws_bwc_rule_complex_hash_node_get(struc
 	if (unlikely(!node))
 		return -ENOMEM;
 
+#ifdef HAVE_IDA_ALLOC
 	ret = ida_alloc(&bwc_matcher->complex->metadata_ida, GFP_KERNEL);
+#else
+	ret = ida_simple_get(&bwc_matcher->complex->metadata_ida, 0, 0, GFP_KERNEL);
+#endif
 	if (ret < 0)
 		goto err_free_node;
 	node->tag = ret;
@@ -1114,7 +1118,11 @@ hws_bwc_rule_complex_hash_node_get(struc
 		 * There's some performance advantage in skipping such cases,
 		 * so this is left for future optimizations.
 		 */
+#ifdef HAVE_IDA_ALLOC
 		ida_free(&bwc_matcher->complex->metadata_ida, node->tag);
+#else
+		ida_simple_remove(&bwc_matcher->complex->metadata_ida, node->tag);
+#endif
 		kfree(node);
 		node = old_node;
 	}
@@ -1123,7 +1131,11 @@ hws_bwc_rule_complex_hash_node_get(struc
 	return 0;
 
 err_free_ida:
+#ifdef HAVE_IDA_ALLOC
 	ida_free(&bwc_matcher->complex->metadata_ida, node->tag);
+#else
+	ida_simple_remove(&bwc_matcher->complex->metadata_ida, node->tag);
+#endif
 err_free_node:
 	kfree(node);
 	return ret;
@@ -1144,7 +1156,11 @@ hws_bwc_rule_complex_hash_node_put(struc
 		rhashtable_remove_fast(&bwc_matcher->complex->refcount_hash,
 				       &node->hash_node,
 				       hws_refcount_hash);
+#ifdef HAVE_IDA_ALLOC
 		ida_free(&bwc_matcher->complex->metadata_ida, node->tag);
+#else
+		ida_simple_remove(&bwc_matcher->complex->metadata_ida, node->tag);
+#endif
 		kfree(node);
 		if (is_last_rule)
 			*is_last_rule = true;
