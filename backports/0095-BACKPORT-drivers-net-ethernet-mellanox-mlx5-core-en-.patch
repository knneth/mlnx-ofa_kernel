From: Valentine Fatiev <valentinef@nvidia.com>
Subject: [PATCH] BACKPORT: drivers/net/ethernet/mellanox/mlx5/core/en/rx_res.c

---
 .../ethernet/mellanox/mlx5/core/en/rx_res.c   | 73 ++++++++++++++++---
 1 file changed, 62 insertions(+), 11 deletions(-)

--- a/drivers/net/ethernet/mellanox/mlx5/core/en/rx_res.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en/rx_res.c
@@ -71,12 +71,27 @@ static int mlx5e_rx_res_rss_init_def(str
 	return 0;
 }
 
-int mlx5e_rx_res_rss_init(struct mlx5e_rx_res *res, u32 rss_idx, unsigned int init_nch)
+int mlx5e_rx_res_rss_init(struct mlx5e_rx_res *res,
+#ifdef HAVE_CORE_TRACKS_CUSTOM_RSS_CONTEXTS
+			  u32 rss_idx
+#else
+			  u32 *rss_idx
+#endif
+			  , unsigned int init_nch)
 {
 	bool inner_ft_support = res->features & MLX5E_RX_RES_FEATURE_INNER_FT;
 	struct mlx5e_rss *rss;
+#ifndef HAVE_CORE_TRACKS_CUSTOM_RSS_CONTEXTS
+		int i;
 
+	for (i = 1; i < MLX5E_MAX_NUM_RSS; i++)
+		if (!res->rss[i])
+			break;
+
+	if (i == MLX5E_MAX_NUM_RSS)
+#else
 	if (WARN_ON_ONCE(res->rss[rss_idx]))
+#endif
 		return -ENOSPC;
 
 	rss = mlx5e_rss_init(res->mdev, inner_ft_support, res->drop_rqn,
@@ -92,7 +107,12 @@ int mlx5e_rx_res_rss_init(struct mlx5e_r
 		mlx5e_rss_enable(rss, res->rss_rqns, vhca_ids, res->rss_nch);
 	}
 
+#ifndef HAVE_CORE_TRACKS_CUSTOM_RSS_CONTEXTS
+	res->rss[i] = rss;
+	*rss_idx = i;
+#else
 	res->rss[rss_idx] = rss;
+#endif
 
 	return 0;
 }
@@ -187,22 +207,46 @@ void mlx5e_rx_res_rss_set_indir_uniform(
 	mlx5e_rss_set_indir_uniform(res->rss[0], nch);
 }
 
-void mlx5e_rx_res_rss_get_rxfh(struct mlx5e_rx_res *res, u32 rss_idx,
-			       u32 *indir, u8 *key, u8 *hfunc, bool *symmetric)
+#ifdef HAVE_CORE_TRACKS_CUSTOM_RSS_CONTEXTS
+void
+#else
+int
+#endif
+mlx5e_rx_res_rss_get_rxfh(struct mlx5e_rx_res *res, u32 rss_idx,
+			       u32 *indir, u8 *key, u8 *hfunc
+#ifdef HAVE_RXH_XFRM_SYM_OR_XOR
+			       , bool *symmetric
+#endif
+			       )
 {
 	struct mlx5e_rss *rss = NULL;
 
 	if (rss_idx < MLX5E_MAX_NUM_RSS)
 		rss = res->rss[rss_idx];
+#ifdef HAVE_CORE_TRACKS_CUSTOM_RSS_CONTEXTS
 	if (WARN_ON_ONCE(!rss))
 		return;
+#else
+	if (!rss)
+		return -ENOENT;
+#endif
 
-	mlx5e_rss_get_rxfh(rss, indir, key, hfunc, symmetric);
+	mlx5e_rss_get_rxfh(rss, indir, key, hfunc
+#ifdef HAVE_RXH_XFRM_SYM_OR_XOR
+			  , symmetric
+#endif
+			   );
+#ifndef HAVE_CORE_TRACKS_CUSTOM_RSS_CONTEXTS
+	return 0;
+#endif
 }
 
 int mlx5e_rx_res_rss_set_rxfh(struct mlx5e_rx_res *res, u32 rss_idx,
-			      const u32 *indir, const u8 *key, const u8 *hfunc,
-			      const bool *symmetric)
+			      const u32 *indir, const u8 *key, const u8 *hfunc
+#ifdef HAVE_RXH_XFRM_SYM_OR_XOR
+			      , const bool *symmetric
+#endif
+				)
 {
 	u32 *vhca_ids = get_vhca_ids(res, 0);
 	struct mlx5e_rss *rss;
@@ -214,7 +258,10 @@ int mlx5e_rx_res_rss_set_rxfh(struct mlx
 	if (!rss)
 		return -ENOENT;
 
-	return mlx5e_rss_set_rxfh(rss, indir, key, hfunc, symmetric,
+	return mlx5e_rss_set_rxfh(rss, indir, key, hfunc,
+#ifdef HAVE_RXH_XFRM_SYM_OR_XOR
+				  symmetric,
+#endif
 				  res->rss_rqns, vhca_ids, res->rss_nch);
 }
 
@@ -560,9 +607,11 @@ void mlx5e_rx_res_channels_activate(stru
 	for (ix = 0; ix < chs->num; ix++) {
 		u32 *vhca_id = get_vhca_ids(res, ix);
 
-		if (mlx5e_channels_is_xsk(chs, ix))
-			mlx5e_channels_get_xsk_rqn(chs, ix, &res->rss_rqns[ix], vhca_id);
-		else
+#ifdef HAVE_XSK_ZERO_COPY_SUPPORT
+       	if (mlx5e_channels_is_xsk(chs, ix))
+       		mlx5e_channels_get_xsk_rqn(chs, ix, &res->rss_rqns[ix], vhca_id);
+       	else
+#endif
 			mlx5e_channels_get_regular_rqn(chs, ix, &res->rss_rqns[ix], vhca_id);
 	}
 	res->rss_nch = chs->num;
@@ -612,9 +661,11 @@ void mlx5e_rx_res_xsk_update(struct mlx5
 {
 	u32 *vhca_id = get_vhca_ids(res, ix);
 
+#ifdef HAVE_XSK_ZERO_COPY_SUPPORT
 	if (xsk)
 		mlx5e_channels_get_xsk_rqn(chs, ix, &res->rss_rqns[ix], vhca_id);
 	else
+#endif
 		mlx5e_channels_get_regular_rqn(chs, ix, &res->rss_rqns[ix], vhca_id);
 
 	mlx5e_rx_res_rss_enable(res);
