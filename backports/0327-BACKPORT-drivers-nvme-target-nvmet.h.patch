From: Valentine Fatiev <valentinef@nvidia.com>
Subject: [PATCH] BACKPORT: drivers/nvme/target/nvmet.h

Change-Id: I3b70df3c981104ae241ec55794daf59e3c38b069
---
 drivers/nvme/target/nvmet.h | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

--- a/drivers/nvme/target/nvmet.h
+++ b/drivers/nvme/target/nvmet.h
@@ -23,6 +23,16 @@
 #include <linux/radix-tree.h>
 #include <linux/t10-pi.h>
 #include <linux/kfifo.h>
+#include <linux/xarray.h>
+#include <linux/key.h>
+
+#ifndef HAVE_NVME_AUTH_TRANSFORM_KEY_DHCHAP
+#undef CONFIG_NVME_TARGET_AUTH
+#endif
+
+#ifdef HAVE_BLK_INTEGRITY_H
+#define HAVE_BLKDEV_BIO_INTEGRITY_BYTES
+#endif
 
 #define NVMET_DEFAULT_VS		NVME_VS(2, 1, 0)
 
@@ -101,7 +111,11 @@ struct nvmet_pr_per_ctrl_ref {
 
 struct nvmet_ns {
 	struct percpu_ref	ref;
+#ifdef HAVE_BDEV_FILE_OPEN_BY_PATH	
 	struct file		*bdev_file;
+#elif defined(HAVE_BDEV_RELEASE)
+	struct bdev_handle	*bdev_handle;
+#endif
 	struct block_device	*bdev;
 	struct pci_dev		*pdev;
 	struct file		*file;
@@ -627,7 +641,9 @@ u32 nvmet_connect_cmd_data_len(struct nv
 void nvmet_bdev_set_limits(struct block_device *bdev, struct nvme_id_ns *id);
 u16 nvmet_bdev_parse_io_cmd(struct nvmet_req *req);
 u16 nvmet_file_parse_io_cmd(struct nvmet_req *req);
+#ifdef HAVE_BIO_ADD_ZONE_APPEND_PAGE
 u16 nvmet_bdev_zns_parse_io_cmd(struct nvmet_req *req);
+#endif
 u32 nvmet_admin_cmd_data_len(struct nvmet_req *req);
 u16 nvmet_parse_admin_cmd(struct nvmet_req *req);
 u32 nvmet_discovery_cmd_data_len(struct nvmet_req *req);
@@ -795,9 +811,11 @@ void nvmet_file_ns_revalidate(struct nvm
 bool nvmet_ns_revalidate(struct nvmet_ns *ns);
 u16 blk_to_nvme_status(struct nvmet_req *req, blk_status_t blk_sts);
 
+#ifdef HAVE_BIO_ADD_ZONE_APPEND_PAGE
 bool nvmet_bdev_zns_enable(struct nvmet_ns *ns);
 void nvmet_execute_identify_ctrl_zns(struct nvmet_req *req);
 void nvmet_execute_identify_ns_zns(struct nvmet_req *req);
+#endif
 void nvmet_bdev_execute_zone_mgmt_recv(struct nvmet_req *req);
 void nvmet_bdev_execute_zone_mgmt_send(struct nvmet_req *req);
 void nvmet_bdev_execute_zone_append(struct nvmet_req *req);
