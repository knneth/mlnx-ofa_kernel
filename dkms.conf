# dkms.conf is technically a bash scriptlet that should generate four arrays:
# BUILT_MODULE_NAME[$n]: module name
# BUILT_MODULE_LOCATION[$n]: location of the module in the build tree
# DEST_MODULE_NAME[$n]:
# DEST_MODULE_LOCATION[$n]
# As well as a few extra variables.
#
# With the multiple modules we have here, and the need to support
# various configurations and kernel versions, it seems pointless to
# create one statically
#
# The test of mlnx_ofed_module_disabled() is an essential run-time one:
# it depends on the version of the kernel we build with. $kernel_source_dir
# is set by dkms. This file assumes it has a .config file (there seems
# to be no bullet-proof method of finding the path to the generated
# config directory of the kernel from that path, sadly).
#
# To see the generated content for a specific kernel:
# (kernel_source_dir=/path/to/kernel/source; . dkms.conf; mlnx_ofed_dump)

# Module name. Note that the deb uses a different module name and edits
# this field:
PACKAGE_NAME="mlnx-ofa_kernel"
# Version: Needs to be edited at DKMS package build time:
PACKAGE_VERSION="@VERSION@"

# Pre-build command: this is actually a major part of the build. Errors
# from this will not be in make.log.
# Note the single quote. Expansion is at command exection time (at dkms
# module build time. Variables come from the dkms script).
PRE_BUILD='./configure --kernel-sources=$kernel_source_dir --default --build-dummy-mods --with-njobs=$parallel_jobs'
# Note that this "post build" command installs files. This is needed
# because the file in the build directory are deleted at the end of the
# build. They are needeed for other module packages to be built (e.g.:
# srp and mlnx-nvme).
POST_BUILD='./ofed_scripts/dkms_ofed_post_build.sh /usr/src/ofa_kernel/$arch/$kernelver'

AUTOINSTALL=yes

# It seems that this seemingly default value is required:
MAKE[0]="make"

mlnx_ofed_is_conf_set() {
	grep -q "$1" "$kernel_source_dir/include/generated/autoconf.h" 2>/dev/null
}

# Some kernel modules are only available with some configurations
mlnx_ofed_module_disabled() {
	case "$1" in
	# auxiliary was originally included as a backport of the in-kernel
	# code merged in 5.11. With kernel >= 5.11, it is likely to be
	# included in the kernel itself. If so, we don't need to bring it
	# with us:
	auxiliary) mlnx_ofed_is_conf_set CONFIG_AUXILIARY_BUS;;
	fwctl) mlnx_ofed_is_conf_set CONFIG_FWCTL;;

	# Depend on an extra feature in the kernel:
	irdma)		! mlnx_ofed_is_conf_set CONFIG_INFINIBAND_IRDMA;;
	mlx5-vfio-pci)	! mlnx_ofed_is_conf_set CONFIG_MLX5_VFIO_PCI;;
	mlx5_vdpa)	! mlnx_ofed_is_conf_set CONFIG_MLX5_VDPA_NET;;
	mlx5_dpll)	! mlnx_ofed_is_conf_set CONFIG_MLX5_DPLL;;
	*) false;;
	esac
}

mlnx_ofed_modules="
compat/mlx_compat
drivers/fwctl/fwctl
drivers/fwctl/mlx5/mlx5_fwctl
drivers/infiniband/core/ib_core
drivers/infiniband/core/ib_cm
drivers/infiniband/core/iw_cm
drivers/infiniband/core/ib_umad
drivers/infiniband/core/ib_uverbs
drivers/infiniband/core/rdma_cm
drivers/infiniband/core/rdma_ucm
drivers/net/ethernet/mellanox/mlx5/core/mlx5_core
drivers/infiniband/hw/mlx5/mlx5_ib
drivers/infiniband/ulp/ipoib/ib_ipoib
drivers/net/ethernet/mellanox/mlxfw/mlxfw
drivers/base/auxiliary
drivers/infiniband/hw/irdma/irdma
drivers/vfio/pci/mlx5/mlx5-vfio-pci
drivers/vdpa/mlx5/mlx5_vdpa
drivers/net/ethernet/mellanox/mlx5/core/mlx5_dpll
net/mlxdevm/mlxdevm
"

BUILT_MODULE_NAME=()
DEST_MODULE_NAME=()
BUILT_MODULE_LOCATION=()
DEST_MODULE_LOCATION=()
for mlnx_ofed_mod in $mlnx_ofed_modules; do
	mlnx_ofed_mod_name=${mlnx_ofed_mod##*/}
	mlnx_ofed_mod_dir=${mlnx_ofed_mod%*/*}
	if mlnx_ofed_module_disabled $mlnx_ofed_mod_name; then
		continue
	fi
	BUILT_MODULE_NAME+=("$mlnx_ofed_mod_name")
	DEST_MODULE_NAME+=("$mlnx_ofed_mod_name")
	BUILT_MODULE_LOCATION+=("$mlnx_ofed_mod_dir")
	DEST_MODULE_LOCATION+=("/kernel/$mlnx_ofed_mod_dir")
done

mlnx_ofed_dump() {
	local var arr len i

	for var in PACKAGE_NAME PACKAGE_VERSION PRE_BUILD POST_BUILD AUTOINSTALL; do
		echo "$var=\"${!var}\""
	done
	len=${#BUILT_MODULE_NAME[@]}
	for i in `seq 0 $((len - 1))`; do
		cat <<EOF
#Module $i:
	BUILT_MODULE_NAME[$i]="${BUILT_MODULE_NAME[$i]}"
	DEST_MODULE_NAME[$i]="${DEST_MODULE_NAME[$i]}"
	BUILT_MODULE_LOCATION[$i]="${BUILT_MODULE_LOCATION[$i]}"
	DEST_MODULE_LOCATION[$i]="${DEST_MODULE_LOCATION[$i]}"

EOF
	done


}
unset mlnx_ofed_modules mlnx_ofed_mod mlnx_ofed_mod_name mlnx_ofed_mod_dir
